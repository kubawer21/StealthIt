<!DOCTYPE html>
<html lang="en">

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stealth Utility</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Critical for transparency */
        html,
        body,
        #root {
            background-color: transparent !important;
            background: transparent !important;
            height: 100vh;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            user-select: none;
        }

        #root {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            width: 100%;
            height: 100%;
        }

        .draggable {
            -webkit-app-region: drag;
        }

        .clickable {
            -webkit-app-region: no-drag;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 4px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 2px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        /* Detached Control Bar */
        .control-bar {
            background: rgba(0, 0, 0, 0.6);
            /* Dark semi-transparent */
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 6px 10px;
            margin-bottom: 12px;
            /* Detached gap */
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
            transition: all 0.2s ease;
        }

        /* Main Panel */
        .main-panel {
            background: rgba(0, 0, 0, 0.75);
            /* Darker for readability */
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            width: 100%;
            max-width: 600px;
            /* Constraint width if window is wide */
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);

            /* Dynamic Sizing Transitions */
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Dynamic States */
        .main-panel.compact {
            flex-grow: 0;
            height: auto;
            /* Shrink to fit content */
        }

        .main-panel.expanded {
            flex-grow: 1;
            /* Fill remaining height */
            height: 100%;
            /* Ensure it takes space */
        }

        /* Chat Area */
        #view-chat {
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 4px;
            min-height: 60px;
            /* Minimum height for "Ready" message */
        }

        .compact #view-chat {
            min-height: 40px;
            max-height: 60px;
            /* Limit height in compact mode */
        }

        /* Messages */
        .message-user {
            background: #2563eb;
            /* Blue-600 */
            color: white;
            align-self: flex-end;
            border-radius: 12px 12px 2px 12px;
            margin-left: 20%;
        }

        .message-ai {
            background: rgba(255, 255, 255, 0.08);
            color: #e5e7eb;
            /* Gray-200 */
            align-self: flex-start;
            border-radius: 12px 12px 12px 2px;
            margin-right: 10%;
            position: relative;
            group: true;
            /* For hover effects */
        }

        .message-content {
            padding: 8px 12px;
            font-size: 13px;
            line-height: 1.4;
        }

        /* Copy Button */
        .copy-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            opacity: 0;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 4px;
            padding: 2px;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .message-ai:hover .copy-btn {
            opacity: 1;
        }

        .copy-btn:hover {
            background: rgba(0, 0, 0, 0.6);
            color: white;
        }

        /* Animations */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(8px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-slide-in {
            animation: slideIn 0.2s ease-out forwards;
        }

        .loading-dot {
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .loading-dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .loading-dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes bounce {

            0%,
            80%,
            100% {
                transform: scale(0);
            }

            40% {
                transform: scale(1);
            }
        }
    </style>
</head>

<body>
    <!-- Root Container for Transparency Control -->
    <div id="root">
        <!-- Control Bar (Detached) -->
        <div class="control-bar draggable">
            <!-- Drag Handle Icon -->
            <div class="text-gray-500 cursor-move px-1">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="9" cy="12" r="1"></circle>
                    <circle cx="9" cy="5" r="1"></circle>
                    <circle cx="9" cy="19" r="1"></circle>
                    <circle cx="15" cy="12" r="1"></circle>
                    <circle cx="15" cy="5" r="1"></circle>
                    <circle cx="15" cy="19" r="1"></circle>
                </svg>
            </div>

            <!-- Record Button -->
            <button id="btn-record" class="clickable p-2 rounded-full hover:bg-white/10 transition-colors text-gray-300"
                title="Toggle Recording">
                <svg id="icon-mic" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                    <line x1="12" y1="19" x2="12" y2="23"></line>
                    <line x1="8" y1="23" x2="16" y2="23"></line>
                </svg>
            </button>

            <!-- Screenshot Button -->
            <button id="btn-screenshot"
                class="clickable p-2 rounded-full hover:bg-white/10 transition-colors text-gray-300"
                title="Take Screenshot">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                    <circle cx="12" cy="13" r="4"></circle>
                </svg>
            </button>

            <!-- Settings Button -->
            <button id="btn-settings"
                class="clickable p-2 rounded-full hover:bg-white/10 transition-colors text-gray-300" title="Settings">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path
                        d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
                    </path>
                </svg>
            </button>

            <!-- Toggle View Button (Manual Uncollapse) -->
            <button id="btn-toggle-view"
                class="clickable p-2 rounded-full hover:bg-white/10 transition-colors text-gray-300"
                title="Toggle View (Expand/Collapse)">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="15 3 21 3 21 9"></polyline>
                    <polyline points="9 21 3 21 3 15"></polyline>
                    <line x1="21" y1="3" x2="14" y2="10"></line>
                    <line x1="3" y1="21" x2="10" y2="14"></line>
                </svg>
            </button>

            <!-- Close Button -->
            <button id="btn-close"
                class="clickable p-2 rounded-full hover:bg-red-500/20 hover:text-red-400 transition-colors text-gray-300"
                title="Close App">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>

        <!-- Main Panel -->
        <div id="main-panel" class="main-panel compact">
            <!-- Chat Area -->
            <div id="view-chat" class="flex flex-col gap-3 p-3">
                <div class="text-gray-400 text-xs text-center mt-2 italic opacity-70">
                    Ready. Press Ctrl+Enter to capture.
                </div>
            </div>

            <!-- Input Area -->
            <div class="p-3 border-t border-white/10 bg-black/20">
                <div class="relative">
                    <input type="text" id="chat-input"
                        class="clickable w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-blue-500/50 focus:bg-white/10 transition-all"
                        placeholder="Ask follow-up...">
                    <div class="absolute right-2 top-2 text-[10px] text-gray-500 pointer-events-none">
                        ‚èé
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal"
        class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="bg-[#1a1a1a] border border-white/10 rounded-xl w-80 shadow-2xl overflow-hidden">
            <div class="p-4 border-b border-white/10 flex justify-between items-center bg-white/5">
                <h3 class="text-sm font-medium text-white">Settings</h3>
                <button onclick="closeSettingsModal()" class="text-gray-400 hover:text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="p-4 space-y-4">
                <div>
                    <label class="block text-xs text-gray-400 mb-1">Gemini API Key</label>
                    <input type="password" id="setting-api-key"
                        class="clickable w-full bg-black/30 border border-white/10 rounded px-2 py-1.5 text-xs text-white focus:border-blue-500/50 focus:outline-none">
                </div>
                <div>
                    <label class="block text-xs text-gray-400 mb-1">System Prompt</label>
                    <textarea id="setting-prompt" rows="3"
                        class="clickable w-full bg-black/30 border border-white/10 rounded px-2 py-1.5 text-xs text-white focus:border-blue-500/50 focus:outline-none"></textarea>
                </div>
            </div>
            <div class="p-3 border-t border-white/10 bg-white/5 flex justify-end">
                <button onclick="saveSettings()"
                    class="clickable bg-blue-600 hover:bg-blue-500 text-white text-xs px-3 py-1.5 rounded transition-colors">
                    Save Changes
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- UI Logic ---
        const mainPanel = document.getElementById('main-panel');
        const chatView = document.getElementById('view-chat');
        const chatInput = document.getElementById('chat-input');
        const btnRecord = document.getElementById('btn-record');
        const iconMic = document.getElementById('icon-mic');

        // Auto-resize logic
        function updatePanelSize(forceExpand = false) {
            const hasMessages = chatView.querySelectorAll('.message-user, .message-ai').length > 0;
            const isCompact = mainPanel.classList.contains('compact');

            if (forceExpand || (hasMessages && isCompact)) {
                mainPanel.classList.remove('compact');
                mainPanel.classList.add('expanded');
                // Only call backend if we are actually changing state to avoid unnecessary calls
                if (isCompact) pywebview.api.toggle_collapse();
            } else if (!hasMessages && !isCompact && !forceExpand) {
                mainPanel.classList.add('compact');
                mainPanel.classList.remove('expanded');
                pywebview.api.toggle_collapse();
            }
        }

        function appendMessage(text, isAi = false) {
            // Remove "Ready" message if present
            const readyMsg = chatView.querySelector('.text-center');
            if (readyMsg) readyMsg.remove();

            const msgDiv = document.createElement('div');
            msgDiv.className = isAi ? 'message-ai flex flex-col animate-slide-in' : 'message-user animate-slide-in';

            let contentHtml = `<div class="message-content">${text}</div>`;

            if (isAi) {
                // Add Copy Button for AI
                contentHtml += `
                    <div class="copy-btn" onclick="copyToClipboard(this, '${text.replace(/'/g, "\\'")}')" title="Copy">
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                    </div>
                `;
            }

            msgDiv.innerHTML = contentHtml;
            chatView.appendChild(msgDiv);
            chatView.scrollTop = chatView.scrollHeight;

            // Force expand when a message is added
            updatePanelSize(true);
        }

        function showLoading(show) {
            const existingLoader = document.getElementById('loader');
            if (existingLoader) existingLoader.remove();

            if (show) {
                const loader = document.createElement('div');
                loader.id = 'loader';
                loader.className = 'message-ai flex items-center gap-1 p-3 w-12 justify-center animate-slide-in';
                loader.innerHTML = `
                    <div class="loading-dot w-1.5 h-1.5 bg-gray-400 rounded-full"></div>
                    <div class="loading-dot w-1.5 h-1.5 bg-gray-400 rounded-full"></div>
                    <div class="loading-dot w-1.5 h-1.5 bg-gray-400 rounded-full"></div>
                `;
                chatView.appendChild(loader);
                chatView.scrollTop = chatView.scrollHeight;
                updatePanelSize();
            }
        }

        function copyToClipboard(btn, text) {
            navigator.clipboard.writeText(text).then(() => {
                // Visual feedback
                const originalIcon = btn.innerHTML;
                btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#4ade80" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`;
                setTimeout(() => {
                    btn.innerHTML = originalIcon;
                }, 1500);
            });
        }

        // --- Backend Callbacks ---
        function onAiResponse(response) {
            showLoading(false);
            appendMessage(response, true);
        }

        function updateTranscript(text) {
            // Optional: Show live transcript if desired
            // console.log("Transcript:", text);
        }

        // --- Event Listeners ---
        chatInput.addEventListener('keydown', (e) => {
            // Fix: Ignore if Ctrl is pressed to avoid conflict with global hotkey
            if (e.ctrlKey) return;

            if (e.key === 'Enter' && chatInput.value.trim()) {
                const text = chatInput.value.trim();
                appendMessage(text, false);
                pywebview.api.send_message(text);
                chatInput.value = '';
                showLoading(true);
            }
        });

        document.getElementById('btn-record').addEventListener('click', async () => {
            const isRecording = await pywebview.api.toggle_record();
            if (isRecording) {
                iconMic.classList.add('text-red-500', 'animate-pulse');
                btnRecord.classList.add('bg-white/10');
            } else {
                iconMic.classList.remove('text-red-500', 'animate-pulse');
                btnRecord.classList.remove('bg-white/10');
            }
        });

        document.getElementById('btn-screenshot').addEventListener('click', () => {
            pywebview.api.take_screenshot();
        });

        document.getElementById('btn-close').addEventListener('click', () => {
            pywebview.api.close_app();
        });

        // Settings Modal
        function showSettingsModal(config) {
            document.getElementById('setting-api-key').value = config.api_key || '';
            document.getElementById('setting-prompt').value = config.prompt || '';
            document.getElementById('settings-modal').classList.remove('hidden');
        }

        function closeSettingsModal() {
            document.getElementById('settings-modal').classList.add('hidden');
        }

        function saveSettings() {
            const newConfig = {
                api_key: document.getElementById('setting-api-key').value,
                prompt: document.getElementById('setting-prompt').value
            };
            pywebview.api.save_settings(newConfig);
        }

        document.getElementById('btn-settings').addEventListener('click', () => {
            pywebview.api.open_settings();
        });

        document.getElementById('btn-toggle-view').addEventListener('click', () => {
            const isCompact = mainPanel.classList.contains('compact');
            if (isCompact) {
                mainPanel.classList.remove('compact');
                mainPanel.classList.add('expanded');
            } else {
                mainPanel.classList.add('compact');
                mainPanel.classList.remove('expanded');
            }
            pywebview.api.toggle_collapse();
        });

    </script>
</body>

</html>